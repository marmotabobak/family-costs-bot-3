{% extends "costs/base.html" %}

{% macro sort_header(field, label, order_by, order_dir, per_page, filter_qs) %}
{% set base_url = root_path ~ "/costs?page=1&per_page=" ~ per_page %}
{% if filter_qs %} {% set base_url = base_url ~ "&" ~ filter_qs %} {% endif %}
{% if order_by == field and order_dir == 'desc' %}
<a href="{{ base_url }}&order_by={{ field }}&order_dir=asc" class="sort-link sort-active">{{ label }} ↑</a>
{%- elif order_by == field -%}
<a href="{{ base_url }}&order_by={{ field }}&order_dir=desc" class="sort-link sort-active">{{ label }} ↓</a>
{%- else -%}
<a href="{{ base_url }}&order_by={{ field }}&order_dir=desc" class="sort-link">{{ label }}</a>
{%- endif %}
{% endmacro %}

{% block title %}Список расходов{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Расходы</h2>
        <a href="{{ root_path }}/costs/add" class="btn btn-primary">Добавить</a>
    </div>

    <div class="filter-bar">
        <form method="get" action="{{ root_path }}/costs" class="filter-form">
            <input type="hidden" name="order_by" value="{{ order_by }}">
            <input type="hidden" name="order_dir" value="{{ order_dir }}">
            <input type="hidden" name="per_page" value="{{ costs.per_page }}">

            <div class="filter-row">
                <div class="filter-group">
                    <label>Содержит текст:</label>
                    <input type="text" name="filter_name" value="{{ filters.name }}" placeholder="Поиск по названию">
                </div>
                <div class="filter-group">
                    <label>Пользователь:</label>
                    <select name="filter_user_id">
                        <option value="">Все</option>
                        {% for user in users %}
                        <option value="{{ user.telegram_id }}" {% if filters.user_id == user.telegram_id %}selected{% endif %}>{{ user.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Дата с:</label>
                    <input type="date" name="filter_date_from" value="{{ filters.date_from }}">
                </div>
                <div class="filter-group">
                    <label>Дата по:</label>
                    <input type="date" name="filter_date_to" value="{{ filters.date_to }}">
                </div>
                <div class="filter-group">
                    <label>Сумма от:</label>
                    <input type="text" name="filter_amount_from" value="{{ filters.amount_from }}" placeholder="0">
                </div>
                <div class="filter-group">
                    <label>Сумма до:</label>
                    <input type="text" name="filter_amount_to" value="{{ filters.amount_to }}" placeholder="999999">
                </div>
                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary btn-small">Фильтр</button>
                    {% if filters.is_active() %}
                    <a href="{{ root_path }}/costs?order_by={{ order_by }}&order_dir={{ order_dir }}&per_page={{ costs.per_page }}" class="btn btn-secondary btn-small">Сброс</a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>

    <div class="controls-bar">
        <div class="per-page-selector">
            <label>На странице:</label>
            <select onchange="window.location.href='{{ root_path }}/costs?page=1&per_page=' + this.value + '&order_by={{ order_by }}&order_dir={{ order_dir }}{% if filters.is_active() %}&{{ filters.to_query_string() }}{% endif %}'">
                {% for n in [20, 50, 100, 200] %}
                <option value="{{ n }}" {% if costs.per_page == n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
            </select>
        </div>
        <span class="total-info">Всего: {{ costs.total }}{% if filters.is_active() %} (отфильтровано){% endif %}</span>
    </div>

    {% if costs.items %}
    <div class="bulk-actions bulk-actions-disabled" id="bulkActions">
        <span id="selectedCount">0 выбрано</span>
        <form id="bulkDeleteForm" action="{{ root_path }}/costs/bulk-delete" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn btn-danger btn-small" disabled>Удалить</button>
        </form>
        <form id="bulkDateForm" action="{{ root_path }}/costs/bulk-change-date" method="post" class="bulk-date-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="date" name="new_date" disabled>
            <button type="submit" class="btn btn-secondary btn-small" disabled>Изменить дату</button>
        </form>
        <form id="bulkUserForm" action="{{ root_path }}/costs/bulk-change-user" method="post" class="bulk-user-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <select name="new_user_id" disabled>
                <option value="">Пользователь</option>
                {% for user in users %}
                <option value="{{ user.telegram_id }}">{{ user.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-secondary btn-small" disabled>Изменить польз.</button>
        </form>
    </div>

    <div class="costs-table-wrapper">
        <table class="costs-table">
            <thead>
                <tr>
                    <th class="cb-col"><input type="checkbox" id="selectAll"></th>
                    <th>{{ sort_header('id', 'ID', order_by, order_dir, costs.per_page, filters.to_query_string()) }}</th>
                    <th>{{ sort_header('name', 'Название', order_by, order_dir, costs.per_page, filters.to_query_string()) }}</th>
                    <th>{{ sort_header('amount', 'Сумма', order_by, order_dir, costs.per_page, filters.to_query_string()) }}</th>
                    <th>{{ sort_header('user_id', 'Пользователь', order_by, order_dir, costs.per_page, filters.to_query_string()) }}</th>
                    <th>{{ sort_header('created_at', 'Дата', order_by, order_dir, costs.per_page, filters.to_query_string()) }}</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for cost in costs.items %}
                <tr>
                    <td class="cb-col"><input type="checkbox" class="row-checkbox" value="{{ cost.id }}"></td>
                    <td>{{ cost.id }}</td>
                    <td>{{ cost.name }}</td>
                    <td class="amount {% if cost.amount < 0 %}negative{% endif %}">{{ cost.amount|format_amount }}</td>
                    <td>{{ users_map.get(cost.user_id, cost.user_id) }}</td>
                    <td>{{ cost.created_at.strftime('%d.%m.%Y') }}</td>
                    <td class="actions">
                        <a href="{{ root_path }}/costs/{{ cost.id }}/edit" class="btn btn-secondary btn-small">Изменить</a>
                        <form action="{{ root_path }}/costs/{{ cost.id }}/delete" method="post" class="inline-form" onsubmit="return confirm('Удалить запись?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" class="btn btn-danger btn-small">Удалить</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if costs.total_pages > 1 %}
    <div class="pagination">
        {% if costs.page > 1 %}
        <a href="{{ root_path }}/costs?page={{ costs.page - 1 }}&per_page={{ costs.per_page }}&order_by={{ order_by }}&order_dir={{ order_dir }}{% if filters.is_active() %}&{{ filters.to_query_string() }}{% endif %}" class="btn btn-secondary">&laquo; Назад</a>
        {% endif %}

        <span class="page-info">Страница {{ costs.page }} из {{ costs.total_pages }} (всего: {{ costs.total }})</span>

        {% if costs.page < costs.total_pages %}
        <a href="{{ root_path }}/costs?page={{ costs.page + 1 }}&per_page={{ costs.per_page }}&order_by={{ order_by }}&order_dir={{ order_dir }}{% if filters.is_active() %}&{{ filters.to_query_string() }}{% endif %}" class="btn btn-secondary">Вперёд &raquo;</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <p class="empty-message">Расходов пока нет. <a href="{{ root_path }}/costs/add">Добавьте первый!</a></p>
    {% endif %}
</div>

{% if costs.items %}
<script>
(function() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const bulkBar = document.getElementById('bulkActions');
    const countLabel = document.getElementById('selectedCount');
    const deleteForm = document.getElementById('bulkDeleteForm');
    const dateForm = document.getElementById('bulkDateForm');
    const userForm = document.getElementById('bulkUserForm');

    function updateBulkBar() {
        const checked = [...checkboxes].filter(cb => cb.checked);
        const hasSelection = checked.length > 0;

        // Toggle disabled class on bar
        bulkBar.classList.toggle('bulk-actions-disabled', !hasSelection);

        // Update count label
        countLabel.textContent = checked.length + ' выбрано';

        // Enable/disable all form controls
        bulkBar.querySelectorAll('button, input, select').forEach(el => {
            el.disabled = !hasSelection;
        });

        // Update selectAll checkbox state
        selectAll.checked = checked.length === checkboxes.length && checkboxes.length > 0;
        selectAll.indeterminate = checked.length > 0 && checked.length < checkboxes.length;
    }

    selectAll.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateBulkBar();
    });
    checkboxes.forEach(cb => cb.addEventListener('change', updateBulkBar));

    function addSelectedIds(form) {
        form.querySelectorAll('input[name="ids"]').forEach(i => i.remove());
        [...checkboxes].filter(cb => cb.checked).forEach(cb => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'ids';
            input.value = cb.value;
            form.appendChild(input);
        });
    }

    deleteForm.addEventListener('submit', function(e) {
        const count = [...checkboxes].filter(cb => cb.checked).length;
        if (!confirm('Удалить ' + count + ' записей? Это нельзя отменить.')) {
            e.preventDefault();
            return;
        }
        addSelectedIds(this);
    });

    dateForm.addEventListener('submit', function(e) {
        const dateInput = this.querySelector('input[name="new_date"]');
        if (!dateInput.value) {
            e.preventDefault();
            alert('Выберите дату');
            return;
        }
        const count = [...checkboxes].filter(cb => cb.checked).length;
        if (!confirm('Изменить дату для ' + count + ' записей на ' + dateInput.value + '?')) {
            e.preventDefault();
            return;
        }
        addSelectedIds(this);
    });

    userForm.addEventListener('submit', function(e) {
        const userSelect = this.querySelector('select[name="new_user_id"]');
        if (!userSelect.value) {
            e.preventDefault();
            alert('Выберите пользователя');
            return;
        }
        const count = [...checkboxes].filter(cb => cb.checked).length;
        const userName = userSelect.options[userSelect.selectedIndex].text;
        if (!confirm('Изменить пользователя для ' + count + ' записей на "' + userName + '"?')) {
            e.preventDefault();
            return;
        }
        addSelectedIds(this);
    });
})();
</script>
{% endif %}
{% endblock %}
